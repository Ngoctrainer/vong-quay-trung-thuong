const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbzArX14knfikt6_SsQjnW88b9jrvoAeH9qmA-mjmdMs98P071OSIOgdtHPLS0yV69i9Ng/exec";

const usernameInput = document.getElementById('username');
const startBtn = document.getElementById('startBtn');
const spinBtn = document.getElementById('spinBtn');
const spinInfo = document.getElementById('spinInfo');
const wheel = document.getElementById('wheel');
const resultMessage = document.getElementById('resultMessage');

let currentSpins = 0;

startBtn.addEventListener('click', async () => {
  const username = usernameInput.value.trim();
  if (!username) {
    alert("Vui lòng nhập username!");
    return;
  }

  spinInfo.textContent = "Đang kiểm tra lượt quay...";
  try {
    const res = await fetch(`${SCRIPT_URL}?action=getSpins&username=${encodeURIComponent(username)}`);
    const data = await res.json();
    if (data.error || data.spins === undefined) {
      spinInfo.textContent = "Không tìm thấy username hoặc lỗi server.";
      spinBtn.disabled = true;
    } else {
      currentSpins = data.spins;
      if (currentSpins > 0) {
        spinInfo.textContent = `Bạn còn ${currentSpins} lượt quay.`;
        spinBtn.disabled = false;
      } else {
        spinInfo.textContent = "Bạn đã hết lượt quay.";
        spinBtn.disabled = true;
      }
    }
  } catch (err) {
    console.error(err);
    spinInfo.textContent = "Lỗi kết nối server.";
  }
});

spinBtn.addEventListener('click', async () => {
  if (currentSpins <= 0) return;

  spinBtn.disabled = true;

  const prizes = [
    { code: "A+", percent: 0.5 },
    { code: "A", percent: 2 },
    { code: "B", percent: 5 },
    { code: "C", percent: 5 },
    { code: "D", percent: 10 },
    { code: "E", percent: 10 },
    { code: "F", percent: 17.5 },
    { code: "G", percent: 50 }
  ];

  let r = Math.random() * 100;
  let selectedPrize = prizes.find(p => {
    r -= p.percent;
    return r < 0;
  }) || prizes[prizes.length - 1];

  // Xoay vòng quay
  let angle = prizes.slice(0, prizes.indexOf(selectedPrize)).reduce((sum, p) => sum + p.percent, 0) * 3.6;
  angle += Math.random() * selectedPrize.percent * 3.6;
  let rotateAngle = 1800 + angle;
  wheel.style.transform = `rotate(${rotateAngle}deg)`;

  setTimeout(() => {
    if (selectedPrize.code === "G") {
      resultMessage.textContent = "Chúc may mắn lần sau!";
    } else {
      resultMessage.textContent = `Chúc mừng! Bạn trúng giải ${selectedPrize.code}`;
    }
  }, 4000);

  // Gửi log
  try {
    const res = await fetch(`${SCRIPT_URL}?action=spin&username=${encodeURIComponent(usernameInput.value.trim())}&prize=${selectedPrize.code}`);
    const data = await res.json();
    currentSpins = data.spins || 0;
    spinInfo.textContent = currentSpins > 0 ? `Bạn còn ${currentSpins} lượt quay.` : "Bạn đã hết lượt quay.";
  } catch (err) {
    console.error("Log lỗi:", err);
  }

  setTimeout(() => {
    if (currentSpins > 0) {
      spinBtn.disabled = false;
    }
  }, 4500);
});
